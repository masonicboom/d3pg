<html>
  <head>
    <title>D3 Playground</title>
    <script src='jquery-1.7.1.min.js'></script>
    <script src='d3/d3.v2.js'></script>
    <script src='ace-0.2.0/src/ace.js'></script>
    <script src="ace-0.2.0/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
    <script src="ace-0.2.0/src/mode-css.js" type="text/javascript" charset="utf-8"></script>
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <style>
      #code_editor_container { height: 300px; }
      #code_editor {
        position: absolute;
        width: 620px;
        height: 300px;
      }

      #css_editor_container { height: 300px; }
      #css_editor {
        position: absolute;
        width: 300px;
        height: 300px;
      }

      #result {
        min-height: 200px;
        border: 1px solid #DFDFDF;
        margin-bottom: 2ex;
      }
    </style>
    <script>
      $('document').ready(function() {
        // Initialize editors.
        var code_editor = ace.edit('code_editor');
        var css_editor = ace.edit('css_editor');

        var JavaScriptMode = require("ace/mode/javascript").Mode;
        var CssMode = require("ace/mode/css").Mode;

        code_editor.getSession().setMode(new JavaScriptMode());
        code_editor.getSession().setTabSize(2);
        code_editor.getSession().setUseSoftTabs(true);

        css_editor.getSession().setMode(new CssMode());
        css_editor.getSession().setTabSize(2);
        css_editor.getSession().setUseSoftTabs(true);

        // This function executes the contents of the editors.
        var test = function() {
          $('#result').empty();
          var code = code_editor.getSession().getValue();
          var css = css_editor.getSession().getValue();

          $('#live_code').remove();
          $('#live_css').remove();

          $('body').append('<script id="live_code">'+code+'<\/script>');
          $('body').append('<style id="live_css">'+css+'<\/style>');

          $('#test_code').attr('disabled', 'true');
          $('#test_code').addClass('disabled');

          localStorage['code'] = code;
          localStorage['css'] = css;
        };

        // Load and execute stored code.
        var code = localStorage['code'];
        var css = localStorage['css'];
        if (code != undefined || css != undefined) {
          code_editor.getSession().setValue(code);
          css_editor.getSession().setValue(css);
          test();
        }

        // Run code, disable button, and save code, on button click.
        $('#test_code').click(test);

        // Re-enable button when the code has changed.
        code_editor.getSession().on('change', function() {
          $('#test_code').removeAttr('disabled');
          $('#test_code').removeClass('disabled');
        });
        css_editor.getSession().on('change', function() {
          $('#test_code').removeAttr('disabled');
          $('#test_code').removeClass('disabled');
        });
      });
    </script>
  </head>
  <body>

    <div class='container'>
      <div class='page-header'>
        <h1>D3 Playground</h1>
      </div>

      <div class='row'>
        <div class='span12'>
          <h2>Result</h2>
          <div id='result'></div>
        </div>
      </div>

      <div class='row'>

        <!-- Code editor -->
        <div id='code_wrapper' class='span8'>
          <h2>Code</h2>
          <div id='code_editor_container'>
          <div id='code_editor'>// Data
var data = [
  { x:1, y:1 },
  { x:2, y:1 },
  { x:3, y:2 },
  { x:4, y:3 },
  { x:5, y:5 },
  { x:6, y:8 }
];

// Visualization
var w = $('#result').width(), h = $('#result').height();
var x = d3.scale.linear()
    .domain(d3.extent(data.map(function(d) { return d.x; })))
    .range([0, w]);
var y = d3.scale.linear()
    .domain(d3.extent(data.map(function(d) { return d.y; })))
    .range([0, h]);

var svg = d3.select('#result').append('svg')
    .attr('width', w)
    .attr('height', h);

svg.selectAll('circle')
  .data(data)
  .enter().append('circle')
    .attr('r', '10')
    .attr('fill', 'red')
    .attr('cx', function(d) { return x(d.x); })
    .attr('cy', function(d) { return y(d.y); });
</div></div>
          <br/>
          <button id='test_code' class='btn btn-large btn-primary'><i class='icon-refresh'></i>Test</button>
        </div>

        <!-- CSS editor -->
        <div class='span4'>
          <h2>Style</h2>
          <div id='css_editor_container'>
            <div id='css_editor'>#result circle { fill: green; }</div>
          </div>
        </div>

      </div>
    </div>

  </body>
</html>
